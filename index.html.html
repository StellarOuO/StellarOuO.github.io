<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Journey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        [v-cloak] { display: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .img-preview { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-top: 8px; border: 1px solid #ddd; }
        .shop-thumb { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 1px solid #eee; }
    </style>
</head>
<body class="h-screen w-full flex justify-center bg-gray-200">

    <div id="app" v-cloak class="w-full max-w-md h-full bg-gray-50 flex flex-col relative shadow-2xl overflow-hidden sm:rounded-xl sm:my-4 sm:h-[95vh]">
        
        <div v-if="viewMode === 'dashboard'" class="h-full flex flex-col bg-gray-100">
            <header class="bg-white px-6 py-5 shadow-sm z-10">
                <h1 class="text-2xl font-bold text-gray-800">æˆ‘çš„æ—…ç¨‹ ğŸŒ</h1>
                <p class="text-xs text-gray-500">v.13</p>
            </header>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="bg-indigo-50 border border-indigo-100 rounded-2xl p-4">
                    <h3 class="text-xs font-bold text-indigo-600 mb-2 uppercase tracking-wide">é€šç”¨å·¥å…·</h3>
                    <button @click="openGlobalPacking" class="w-full py-3 bg-white text-indigo-700 font-bold rounded-xl shadow-sm text-sm flex items-center justify-center hover:bg-indigo-50 transition">ğŸ§³ ç·¨è¼¯é€šç”¨è¡Œææ¸…å–®</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button @click="showCreateModal = true" class="py-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-500 font-bold flex flex-col items-center justify-center hover:bg-white hover:border-gray-400 transition"><span class="text-xl mb-1">+</span><span class="text-xs">æ–°æ—…ç¨‹</span></button>
                    <button @click="importTrip" class="py-4 border border-gray-200 bg-white rounded-2xl text-gray-500 font-bold flex flex-col items-center justify-center shadow-sm"><span class="text-xl mb-1">ğŸ“¥</span><span class="text-xs">åŒ¯å…¥</span></button>
                </div>
                <div v-for="trip in sortedTrips" :key="trip.id" @click="openTrip(trip.id)" class="bg-white p-5 rounded-2xl shadow-sm hover:shadow-md transition cursor-pointer relative border-l-4 border-indigo-500">
                    <div class="flex justify-between items-start">
                        <div><h3 class="text-lg font-bold text-gray-800">{{ trip.name }}</h3><p class="text-xs text-gray-500 mt-1">{{ trip.startDate }} å‡ºç™¼</p></div>
                        <div class="text-right"><span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500 block mb-1">{{ trip.members.length }}äºº</span><span class="text-[10px] text-gray-400 font-bold border px-1 rounded">{{ trip.currency || 'Â¥' }}</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="viewMode === 'globalPacking'" class="h-full flex flex-col bg-white">
            <header class="px-4 py-3 border-b flex items-center bg-indigo-600 text-white"><button @click="viewMode = 'dashboard'" class="mr-3 text-xl">â†</button><h1 class="font-bold">é€šç”¨è¡Œææ¸…å–®</h1></header>
            <div class="flex-1 overflow-y-auto p-4 space-y-3">
                <div class="flex bg-gray-100 p-1 rounded-lg mb-3"><button @click="globalPackingType = 'carryOn'" :class="globalPackingType === 'carryOn' ? 'bg-white shadow text-gray-800' : 'text-gray-500'" class="flex-1 py-2 text-xs font-bold rounded-md">ğŸ’ æ‰‹æ</button><button @click="globalPackingType = 'checkIn'" :class="globalPackingType === 'checkIn' ? 'bg-white shadow text-gray-800' : 'text-gray-500'" class="flex-1 py-2 text-xs font-bold rounded-md">ğŸ§³ å¯„è‰™</button></div>
                <div class="flex space-x-2"><input v-model="newGlobalItem" @keyup.enter="addGlobalItem" placeholder="è¼¸å…¥ç‰©å“..." class="flex-1 p-2 border rounded-lg text-sm"><button @click="addGlobalItem" class="bg-indigo-600 text-white px-4 rounded-lg font-bold">+</button></div>
                <div class="space-y-2"><div v-for="(item, idx) in currentGlobalList" :key="idx" class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"><span class="text-sm">{{ item }}</span><button @click="removeGlobalItem(idx)" class="text-red-400 text-xs">åˆªé™¤</button></div></div>
            </div>
        </div>

        <div v-if="viewMode === 'trip'" class="h-full flex flex-col">
            <header class="bg-white px-4 py-3 shadow-sm z-10 flex justify-between items-center">
                <button @click="exitTrip" class="text-gray-500 hover:bg-gray-100 p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg></button>
                <div class="text-center"><h1 class="text-md font-bold text-gray-800">{{ activeTrip.name }}</h1><p class="text-[10px] text-gray-500">{{ activeTrip.startDate }} - {{ activeTrip.endDate }}</p></div>
                <button @click="showTripSettings = true" class="text-gray-500 hover:bg-gray-100 p-2 rounded-full">âš™ï¸</button>
            </header>

            <main class="flex-1 overflow-y-auto no-scrollbar p-4 pb-24">
                
                <div v-if="currentTab === 'itinerary'" class="space-y-4">
                    <div @click="showFlightDetail = !showFlightDetail" class="bg-white rounded-xl shadow-sm border border-blue-100 overflow-hidden cursor-pointer"><div class="bg-blue-50 px-4 py-2 flex justify-between items-center"><span class="text-xs font-bold text-blue-600">âœˆï¸ èˆªç­è³‡æ–™</span><span class="text-xs text-blue-400">{{ showFlightDetail ? 'â–²' : 'â–¼' }}</span></div><div v-if="showFlightDetail" class="p-4 space-y-4"><div class="flex justify-between items-center"><div class="text-center w-1/3"><div class="text-xl font-bold text-gray-800">{{ activeTrip.flights.outbound.depTime || '--:--' }}</div><div class="text-xs text-gray-400">{{ activeTrip.flights.outbound.depAirport || 'HKG' }}</div></div><div class="flex-1 flex flex-col items-center px-2"><span class="text-[10px] text-gray-400">å»ç¨‹</span><div class="h-[1px] w-full bg-gray-300 my-1"></div><span class="text-xs font-bold text-blue-600">{{ activeTrip.flights.outbound.flight || 'Flight' }}</span></div><div class="text-center w-1/3"><div class="text-xl font-bold text-gray-800">{{ activeTrip.flights.outbound.arrTime || '--:--' }}</div><div class="text-xs text-gray-400">{{ activeTrip.flights.outbound.arrAirport || 'DEST' }}</div></div></div><button @click.stop="showFlightModal = true" class="w-full mt-2 py-1 bg-gray-100 text-gray-500 text-xs rounded">ç·¨è¼¯</button></div></div>
                    
                    <div class="flex space-x-2 overflow-x-auto no-scrollbar pb-1"><button v-for="d in generatedDates" :key="d.val" @click="selectedDate = d.val" :class="selectedDate === d.val ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-gray-500 border border-gray-100'" class="flex-shrink-0 px-3 py-2 rounded-lg text-xs font-bold transition-all min-w-[60px] flex flex-col items-center"><span class="opacity-80 text-[10px]">{{ d.weekDay }}</span><span>{{ d.display }}</span></button></div>
                    
                    <div class="space-y-4">
                        <div v-if="filteredItinerary.length === 0" class="text-center py-10 text-gray-400 text-sm">æš«ç„¡è¡Œç¨‹</div>
                        <div v-for="item in filteredItinerary" :key="item.id" @click="openModal('edit', item)" class="bg-white rounded-2xl shadow-sm overflow-hidden border-l-4 cursor-pointer active:scale-95 transition" :class="getCategoryColor(item.category)">
                            <div v-if="item.img" class="h-32 w-full bg-gray-200 bg-cover bg-center" :style="{backgroundImage: 'url(' + item.img + ')'}"></div>
                            <div class="p-3">
                                <div class="flex justify-between items-start mb-2"><div class="flex items-center space-x-2"><span class="font-bold text-lg text-gray-700">{{ item.time }}</span><span class="text-[10px] px-2 py-0.5 rounded-full border" :class="getCategoryBadge(item.category)">{{ getCategoryLabel(item.category) }}</span></div><div class="flex space-x-2"><button v-if="item.mapLink" @click.stop="openLink(item.mapLink)" class="text-blue-500 bg-blue-50 p-1.5 rounded-lg z-10">ğŸ—ºï¸</button><span class="text-gray-300 text-xs p-1.5">âœ</span></div></div>
                                <h3 class="font-bold text-gray-800 text-lg leading-tight">{{ item.location }}</h3>
                                <p v-if="item.note" class="text-gray-500 text-sm mt-1 whitespace-pre-wrap">{{ item.note }}</p>
                            </div>
                        </div>
                    </div>
                    <button @click="openModal('add')" class="fixed bottom-24 right-4 bg-indigo-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-3xl z-20 pb-1 hover:scale-105 active:scale-95 transition">+</button>
                </div>

                <div v-if="currentTab === 'expenses'" class="space-y-5">
                    
                    <div @click="showExchangeDetail = !showExchangeDetail" class="bg-emerald-50 border border-emerald-100 rounded-2xl overflow-hidden cursor-pointer transition-all">
                        <div class="px-4 py-2 flex justify-between items-center bg-emerald-100/50">
                            <span class="text-xs font-bold text-emerald-800">ğŸ’± å¹³å‡åŒ¯ç‡ (é»æ“Šå±•é–‹)</span>
                            <span class="text-xs text-emerald-600">{{ showExchangeDetail ? 'â–²' : 'â–¼' }}</span>
                        </div>
                        <div v-if="showExchangeDetail" class="p-4 relative">
                            <button @click.stop="showExchangeModal = true" class="absolute top-4 right-4 text-emerald-600 bg-white p-1.5 rounded-lg text-xs font-bold shadow-sm border border-emerald-100">+ å…Œæ›</button>
                            <div class="flex items-baseline space-x-2">
                                <span class="text-2xl font-bold text-emerald-700">{{ formatRate(exchangeSummary.avgRate) }}</span>
                                <span class="text-xs text-emerald-600">(1 {{ activeTrip.currency || 'Â¥' }} = HKD)</span>
                            </div>
                            <div class="mt-2 text-[10px] text-emerald-600 bg-white/50 p-2 rounded inline-block">
                                ç¸½å…Œæ›: HKD ${{ formatNumber(exchangeSummary.totalHKD) }} â†’ {{ activeTrip.currency || 'Â¥' }}{{ formatNumber(exchangeSummary.totalLocal) }}
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl p-5 text-white shadow-lg relative">
                        <button @click="openStats" class="absolute top-4 right-4 bg-white/20 hover:bg-white/30 p-2 rounded-lg backdrop-blur-sm transition">ğŸ“Š çµ±è¨ˆ</button>
                        <p class="text-xs opacity-80 mb-1">å…¬æ•¸è¢‹ç¾é‡‘ (Cash)</p>
                        <h2 class="text-3xl font-bold tracking-tight mb-4">{{ activeTrip.currency || 'Â¥' }} {{ formatNumber(walletCash) }}</h2>
                        <div class="grid grid-cols-2 gap-3"><button @click="openTransModal('spend')" class="bg-white text-indigo-700 hover:bg-gray-100 py-2 rounded-lg text-xs font-bold shadow-sm">ğŸ’¸ å…¬æ•¸æ”¯å‡º</button><button @click="openTransModal('deposit')" class="bg-white bg-opacity-20 hover:bg-opacity-30 py-2 rounded-lg text-xs font-medium backdrop-blur-sm border border-white/20">ğŸ’° æ¯äººå……å€¼</button></div>
                    </div>
                    
                    <div v-if="hasDebts" class="bg-white rounded-xl p-3 shadow-sm border border-orange-100 text-xs"><h3 class="font-bold text-gray-700 mb-2">âš–ï¸ çµç®—</h3><div v-for="(amount, name) in debtSummary.potOwes" class="flex justify-between p-1 bg-orange-50 text-orange-800 rounded mb-1"><span>å…¬æ•¸æ¬  <b>{{name}}</b></span><b>{{ activeTrip.currency || 'Â¥' }}{{formatNumber(amount)}}</b></div><div v-for="(amount, name) in debtSummary.owesPot" class="flex justify-between p-1 bg-blue-50 text-blue-800 rounded mb-1"><span><b>{{name}}</b> å€Ÿå…¬æ•¸</span><b>{{ activeTrip.currency || 'Â¥' }}{{formatNumber(amount)}}</b></div></div>
                    <div class="grid grid-cols-2 gap-3"><button @click="openTransModal('advance')" class="bg-orange-100 text-orange-700 py-3 rounded-xl text-xs font-bold shadow-sm">ğŸ™‹â€â™‚ï¸ å¹«å…¬æ•¸å¢Šæ”¯</button><button @click="openTransModal('borrow')" class="bg-blue-100 text-blue-700 py-3 rounded-xl text-xs font-bold shadow-sm">ğŸ¤ å•å…¬æ•¸å€ŸéŒ¢</button></div>
                    
                    <div class="bg-white rounded-2xl shadow-sm overflow-hidden text-sm"><div v-if="activeTrip.transactions.length === 0" class="p-4 text-center text-gray-400 text-xs">å°šç„¡ç´€éŒ„</div><div v-for="t in activeTrip.transactions.slice().sort((a,b) => b.id - a.id)" :key="t.id" class="p-3 border-b border-gray-100 flex justify-between items-center"><div class="flex items-center"><div v-if="t.type === 'spend' || t.type === 'advance'" class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center mr-3 text-lg border border-gray-100">{{ getExpCatIcon(t.category) }}</div><div v-else class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center mr-3 text-lg border border-gray-100">{{ t.type === 'deposit' ? 'ğŸ’°' : 'ğŸ¤' }}</div><div><p class="font-medium text-gray-800 text-xs">{{ t.desc || getExpCatLabel(t.category) }} <span v-if="t.who && t.who !== 'All'" class="text-[9px] text-gray-500 bg-gray-100 px-1 rounded ml-1">{{t.who}}</span></p><p class="text-[9px] text-gray-400">{{ t.dateStr || t.date }} Â· {{ getTypeText(t.type) }}</p></div></div><div :class="getAmountColor(t.type)" class="font-bold text-right text-xs">{{ t.type === 'deposit' || t.type === 'borrow' ? '+' : '-' }} {{ activeTrip.currency || 'Â¥' }}{{ formatNumber(t.amount) }}</div></div></div>
                </div>

                <div v-if="currentTab === 'shopping'" class="space-y-4">
                    <button @click="openShopModal('add')" class="w-full py-3 bg-pink-500 text-white rounded-xl font-bold shadow-md hover:bg-pink-600 transition flex items-center justify-center">+ æ–°å¢å¿…è²·</button>
                    <div class="space-y-2">
                        <div v-for="(item, index) in activeTrip.shoppingList" :key="index" class="bg-white p-3 rounded-xl shadow-sm flex items-start justify-between" :class="{'opacity-50': item.done}">
                            <div class="flex space-x-3 flex-1 cursor-pointer" @click="openShopModal('edit', item, index)">
                                <div class="flex-shrink-0" @click.stop="toggleShopItem(index)">
                                    <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center mt-1 transition-colors" :class="item.done ? 'bg-pink-500 border-pink-500' : 'border-gray-300'"><span v-if="item.done" class="text-white text-xs">âœ“</span></div>
                                </div>
                                <div class="flex-shrink-0" v-if="item.img"><img :src="item.img" class="shop-thumb"></div>
                                <div class="flex-1"><p :class="{'line-through': item.done}" class="text-gray-800 text-sm font-bold">{{ item.text }}</p><p v-if="item.store" class="text-xs text-gray-500 bg-gray-100 px-1.5 rounded inline-block mt-1">ğŸ  {{ item.store }}</p></div>
                            </div>
                            <button @click.stop="deleteShopItem(index)" class="text-gray-300 px-2 mt-1">x</button>
                        </div>
                    </div>
                </div>

                <div v-if="currentTab === 'prep'" class="space-y-6">
                    <div class="bg-white rounded-xl shadow-sm p-4"><h3 class="font-bold text-gray-800 mb-3">ğŸ“ å¾…è¾¦ (To-Do)</h3><div class="flex space-x-2 mb-3"><input v-model="newTodo" @keyup.enter="addTodo" placeholder="è²·ä¿éšª..." class="flex-1 p-2 bg-gray-50 rounded-lg text-sm outline-none"><button @click="addTodo" class="bg-gray-800 text-white px-3 rounded-lg">+</button></div><div class="space-y-2"><div v-for="(todo, idx) in activeTrip.todos" :key="idx" class="flex items-center space-x-3" @click="toggleTodo(idx)"><div class="w-5 h-5 rounded border flex items-center justify-center" :class="todo.done ? 'bg-gray-800 border-gray-800' : 'border-gray-300'"><span v-if="todo.done" class="text-white text-xs">âœ“</span></div><span :class="{'line-through text-gray-400': todo.done}" class="text-sm text-gray-700 flex-1">{{ todo.text }}</span><button @click.stop="deleteTodo(idx)" class="text-gray-300 text-xs">Ã—</button></div></div></div>
                    <div class="bg-white rounded-xl shadow-sm p-4"><div class="flex justify-between items-center mb-3"><h3 class="font-bold text-gray-800">ğŸ’ è¡Œææ¸…å–®</h3><button @click="importFromMaster" class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded border border-indigo-100 font-bold">ğŸ“¥ åŒ¯å…¥é€šç”¨</button></div><div class="flex bg-gray-100 p-1 rounded-lg mb-3"><button @click="packingType = 'carryOn'" :class="packingType === 'carryOn' ? 'bg-white shadow text-gray-800' : 'text-gray-500'" class="flex-1 py-1.5 text-xs font-bold rounded-md">æ‰‹æ</button><button @click="packingType = 'checkIn'" :class="packingType === 'checkIn' ? 'bg-white shadow text-gray-800' : 'text-gray-500'" class="flex-1 py-1.5 text-xs font-bold rounded-md">å¯„è‰™</button></div><div class="flex space-x-2 mb-3"><input v-model="newPackItem" @keyup.enter="addPackItem" placeholder="ç‰©å“..." class="flex-1 p-2 bg-gray-50 rounded-lg text-sm outline-none"><button @click="addPackItem" class="bg-gray-800 text-white px-3 rounded-lg">+</button></div><div class="space-y-2"><div v-for="(item, index) in currentPackingList" :key="index" class="flex items-center space-x-3" @click="togglePackItem(index)"><div class="w-5 h-5 rounded border flex items-center justify-center" :class="item.done ? 'bg-green-500 border-green-500' : 'border-gray-300'"><span v-if="item.done" class="text-white text-xs">âœ“</span></div><span :class="{'line-through text-gray-400': item.done}" class="text-sm text-gray-700 flex-1">{{ item.text }}</span><button @click.stop="deletePackItem(index)" class="text-gray-300 px-2">Ã—</button></div></div></div>
                </div>
            </main>

            <nav class="bg-white border-t border-gray-200 flex justify-between px-2 items-center h-16 z-30 absolute bottom-0 w-full">
                <button v-for="tab in tabs" @click="currentTab = tab.id" :class="currentTab === tab.id ? 'text-indigo-600' : 'text-gray-400'" class="flex flex-col items-center flex-1 h-full justify-center active:bg-gray-50"><span class="text-xl mb-0.5">{{ tab.icon }}</span><span class="text-[10px] font-medium">{{ tab.label }}</span></button>
            </nav>
        </div>

        <transition name="fade">
            <div v-if="showCreateModal" class="absolute inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
                    <h3 class="text-xl font-bold mb-4">å»ºç«‹æ–°æ—…ç¨‹ ğŸŒ</h3>
                    <div class="space-y-3">
                        <input v-model="createForm.name" type="text" placeholder="åç¨±" class="w-full p-2 border rounded-lg text-sm">
                        <div class="bg-indigo-50 p-3 rounded-lg">
                            <label class="text-xs font-bold text-gray-500 mb-1 block">è²¨å¹£ç¬¦è™Ÿ</label>
                            <div class="flex space-x-2 mb-2">
                                <input v-model="createForm.currency" type="text" class="w-16 p-2 text-center font-bold border rounded-lg text-indigo-700" placeholder="Â¥">
                                <div class="flex-1 flex flex-wrap gap-2">
                                    <button v-for="c in ['Â¥','$', 'â‚¬', 'Â£', 'â‚©', 'à¸¿', 'TWD']" @click="createForm.currency = c" class="px-2 py-1 bg-white border rounded text-xs font-bold hover:bg-indigo-100 transition">{{ c }}</button>
                                </div>
                            </div>
                            <p class="text-[10px] text-gray-400">å¯ç›´æ¥è¼¸å…¥ (ä¾‹: RM, Rp, CHF)</p>
                        </div>
                        <div class="grid grid-cols-2 gap-3"><input v-model="createForm.start" type="date" class="w-full p-2 border rounded-lg text-sm"><input v-model="createForm.end" type="date" class="w-full p-2 border rounded-lg text-sm"></div>
                        <input v-model="createForm.membersStr" type="text" placeholder="æˆå“¡ (A, B)" class="w-full p-2 border rounded-lg text-sm">
                    </div>
                    <div class="mt-6 flex space-x-3"><button @click="showCreateModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl">å–æ¶ˆ</button><button @click="createTrip" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold">å»ºç«‹</button></div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="showTransModal" class="absolute inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-sm p-5 shadow-2xl">
                    <h3 class="text-lg font-bold mb-4 text-center">{{ transTitle }}</h3>
                    <div class="space-y-4">
                        <div class="relative"><span class="absolute left-3 top-3 text-gray-400 font-bold text-xl">{{ activeTrip.currency || 'Â¥' }}</span><input v-model.number="transForm.amount" type="number" placeholder="é‡‘é¡" class="w-full p-3 pl-8 bg-gray-50 rounded-lg text-2xl font-bold text-center outline-none"></div>
                        <div class="flex items-center space-x-2"><label class="text-xs font-bold text-gray-500">æ—¥æœŸ</label><input v-model="transForm.date" type="date" class="flex-1 p-2 bg-gray-50 rounded-lg text-sm border-none"></div>
                        <div v-if="transMode !== 'spend'"><select v-if="transMode !== 'deposit'" v-model="transForm.who" class="w-full p-3 bg-gray-50 rounded-lg"><option v-for="m in activeTrip.members" :value="m">{{ m }}</option></select><div v-else class="text-center text-xs text-blue-600 bg-blue-50 p-2 rounded">æ¯äºº {{ activeTrip.currency || 'Â¥' }}{{transForm.amount}} (å…± {{activeTrip.members.length}} äºº)</div></div>
                        <div v-if="transMode === 'spend' || transMode === 'advance'"><label class="block text-xs font-bold text-gray-500 mb-2">åˆ†é¡</label><div class="grid grid-cols-4 gap-2"><button v-for="cat in expenseCategories" :key="cat.id" @click="transForm.category = cat.id" :class="transForm.category === cat.id ? 'bg-indigo-100 border-indigo-500 text-indigo-700 ring-1 ring-indigo-500' : 'bg-gray-50 border-gray-100 text-gray-600'" class="py-2 rounded-lg border flex flex-col items-center justify-center transition"><span class="text-xl mb-1">{{ cat.icon }}</span><span class="text-[10px] font-bold">{{ cat.label }}</span></button></div></div>
                        <input v-model="transForm.desc" type="text" placeholder="å‚™è¨»" class="w-full p-3 bg-gray-50 rounded-lg text-sm">
                    </div>
                    <div class="flex space-x-3 mt-6"><button @click="showTransModal = false" class="flex-1 py-3 bg-gray-100 rounded-xl text-sm">å–æ¶ˆ</button><button @click="saveTransaction" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm">ç¢ºèª</button></div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="showStatsModal" class="absolute inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl overflow-y-auto max-h-[80vh]">
                    <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-gray-800">ğŸ“Š æ”¯å‡ºçµ±è¨ˆ</h3><button @click="showStatsModal = false" class="text-gray-400">Ã—</button></div>
                    <div class="bg-indigo-600 text-white p-4 rounded-xl mb-6 shadow-md text-center"><p class="text-xs opacity-80 mb-1">ç¸½å…¬æ•¸æ”¯å‡º</p><h2 class="text-3xl font-bold">{{ activeTrip.currency || 'Â¥' }} {{ formatNumber(expenseStats.total) }}</h2><div class="mt-2 text-xs bg-white/20 rounded py-1 px-2 inline-block">äººå‡: {{ activeTrip.currency || 'Â¥' }} {{ formatNumber(Math.round(expenseStats.total / activeTrip.members.length)) }}</div></div>
                    <div class="mb-6"><h4 class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wide">æ¯æ—¥æ”¯å‡º</h4><div class="space-y-2"><div v-for="(val, date) in expenseStats.byDate" :key="date" class="flex items-center"><span class="w-12 text-xs text-gray-500 font-mono">{{ date.slice(5) }}</span><div class="flex-1 mx-2 h-2 bg-gray-100 rounded-full overflow-hidden"><div class="h-full bg-indigo-500 rounded-full" :style="{width: (val/expenseStats.maxDate*100) + '%'}"></div></div><span class="text-xs font-bold w-16 text-right">{{ activeTrip.currency || 'Â¥' }}{{ formatNumber(val) }}</span></div></div></div><div><h4 class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wide">åˆ†é¡æ”¯å‡º</h4><div class="space-y-3"><div v-for="(val, cat) in expenseStats.byCat" :key="cat" class="flex justify-between items-center border-b border-gray-100 pb-2"><div class="flex items-center"><span class="text-lg mr-2">{{ getExpCatIcon(cat) }}</span><span class="text-sm text-gray-700">{{ getExpCatLabel(cat) }}</span></div><span class="font-bold text-sm">{{ activeTrip.currency || 'Â¥' }} {{ formatNumber(val) }}</span></div></div></div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="showExchangeModal" class="absolute inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
                    <h3 class="text-lg font-bold mb-4">ğŸ’± æ–°å¢åŒ¯ç‡ç´€éŒ„</h3>
                    <div class="space-y-4">
                        <div><label class="text-xs font-bold text-gray-500">æ¸¯å¹£ (HKD)</label><input v-model.number="exchangeForm.hkd" type="number" placeholder="ä»˜å‡º HKD" class="w-full p-2 border rounded-lg text-lg"></div>
                        <div><label class="text-xs font-bold text-gray-500">å¤–å¹£ ({{ activeTrip.currency || 'Local' }})</label><input v-model.number="exchangeForm.local" type="number" placeholder="æ›åˆ°å¤–å¹£" class="w-full p-2 border rounded-lg text-lg"></div>
                        <div class="bg-gray-50 p-2 rounded text-center text-xs text-gray-600" v-if="exchangeForm.hkd && exchangeForm.local">æ˜¯æ¬¡åŒ¯ç‡: {{ formatRate(exchangeForm.hkd / exchangeForm.local) }}</div>
                        <div class="mt-4 border-t pt-2 max-h-32 overflow-y-auto" v-if="activeTrip.exchanges && activeTrip.exchanges.length > 0"><p class="text-xs font-bold text-gray-400 mb-1">ç´€éŒ„:</p><div v-for="ex in activeTrip.exchanges" class="flex justify-between text-xs py-1 border-b border-gray-100 last:border-0"><span>HKD ${{ex.hkd}} â†’ {{ activeTrip.currency || 'Â¥' }}{{ex.local}}</span><span class="text-gray-400">{{formatRate(ex.rate)}} <button @click="deleteExchange(ex.id)" class="text-red-400 ml-2">x</button></span></div></div>
                    </div>
                    <div class="flex gap-2 mt-4"><button @click="showExchangeModal = false" class="flex-1 py-3 bg-gray-100 rounded-lg text-sm">é—œé–‰</button><button @click="saveExchange" class="flex-1 py-3 bg-emerald-600 text-white rounded-lg text-sm font-bold">åŠ å…¥</button></div>
                </div>
            </div>
        </transition>

        <transition name="fade"><div v-if="showShopModal" class="absolute inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4"><div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl"><h3 class="text-lg font-bold mb-4">{{ shopMode === 'edit' ? 'ç·¨è¼¯å¿…è²·' : 'æ–°å¢å¿…è²·' }}</h3><div class="space-y-3"><input v-model="shopForm.text" placeholder="ç‰©å“åç¨±" class="w-full p-2 border rounded-lg"><input v-model="shopForm.store" placeholder="åº—èˆ–" class="w-full p-2 border rounded-lg text-sm"><div class="border border-dashed border-gray-300 p-2 rounded-lg bg-gray-50"><label class="block text-xs font-bold text-gray-500 mb-1">åœ–ç‰‡</label><input v-model="shopForm.img" placeholder="http://..." class="w-full p-2 bg-white rounded border text-xs mb-2 text-gray-600"><label class="w-full py-2 bg-white border border-gray-300 text-gray-600 text-xs font-bold rounded flex items-center justify-center cursor-pointer hover:bg-gray-100">ğŸ“‚ å¾ç›¸ç°¿ä¸Šå‚³<input type="file" accept="image/*" class="hidden" @change="e => handleImageUpload(e, 'shop')"></label><img v-if="shopForm.img" :src="shopForm.img" class="img-preview"></div></div><div class="flex gap-2 mt-4"><button @click="showShopModal=false" class="flex-1 py-3 bg-gray-100 rounded-lg text-sm">å–æ¶ˆ</button><button @click="saveShopItem" class="flex-1 py-3 bg-pink-500 text-white rounded-lg text-sm font-bold">å„²å­˜</button></div></div></div></transition>
        <transition name="fade"><div v-if="showModal" class="absolute inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4"><div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl overflow-y-auto max-h-[90vh]"><h3 class="text-lg font-bold mb-4">{{ modalMode === 'edit' ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3><div class="space-y-3"><div class="flex space-x-2"><input v-model="form.time" type="time" class="w-1/3 p-2 bg-gray-50 rounded-lg border text-sm"><select v-model="form.category" class="w-2/3 p-2 bg-gray-50 rounded-lg border text-sm"><option value="sight">ğŸ¡ æ™¯é»</option><option value="food">ğŸœ åƒå–</option><option value="play">ğŸ¢ ç©æ¨‚</option><option value="stay">ğŸ¨ ä½å®¿</option><option value="other">ğŸ“ å…¶ä»–</option></select></div><input v-model="form.location" placeholder="åœ°é»åç¨±" class="w-full p-2 bg-gray-50 rounded-lg border"><input v-model="form.mapLink" placeholder="Google Maps Link" class="w-full p-2 bg-gray-50 rounded-lg border text-xs"><div class="border border-dashed border-gray-300 p-2 rounded-lg bg-gray-50"><label class="block text-xs font-bold text-gray-500 mb-1">åœ–ç‰‡</label><input v-model="form.img" placeholder="http://..." class="w-full p-2 bg-white rounded border text-xs mb-2"><label class="w-full py-2 bg-white border border-gray-300 text-gray-600 text-xs font-bold rounded flex items-center justify-center cursor-pointer hover:bg-gray-100">ğŸ“‚ å¾ç›¸ç°¿ä¸Šå‚³<input type="file" accept="image/*" class="hidden" @change="e => handleImageUpload(e, 'itinerary')"></label><img v-if="form.img" :src="form.img" class="img-preview"></div><textarea v-model="form.note" placeholder="å‚™è¨» (äº¤é€šã€è¨‚ä½ä»£è™Ÿ...)" class="w-full p-2 bg-gray-50 rounded-lg border h-20"></textarea></div><div class="flex gap-2 mt-4"><button @click="showModal = false" class="flex-1 py-3 bg-gray-100 rounded-lg text-sm">å–æ¶ˆ</button><button v-if="modalMode==='edit'" @click="deleteItem(form.id); showModal=false" class="px-3 bg-red-50 text-red-500 rounded-lg text-sm">åˆªé™¤</button><button @click="saveItem" class="flex-1 py-3 bg-indigo-600 text-white rounded-lg text-sm font-bold">å„²å­˜</button></div></div></div></transition>
        <transition name="fade"><div v-if="showFlightModal" class="absolute inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4"><div class="bg-white rounded-2xl w-full max-w-sm p-5 shadow-2xl overflow-y-auto max-h-[90vh]"><h3 class="text-lg font-bold mb-4">âœˆï¸ ç·¨è¼¯èˆªç­</h3><div class="bg-blue-50 p-3 rounded-xl mb-3"><h4 class="text-xs font-bold text-blue-600 mb-2">å»ç¨‹</h4><input v-model="activeTrip.flights.outbound.date" type="date" class="w-full mb-2 text-xs p-1.5 rounded border"><div class="grid grid-cols-2 gap-2 mb-2"><input v-model="activeTrip.flights.outbound.depTime" type="time" class="w-full text-xs p-1.5 rounded border"><input v-model="activeTrip.flights.outbound.arrTime" type="time" class="w-full text-xs p-1.5 rounded border"></div><div class="grid grid-cols-2 gap-2 mb-2"><input v-model="activeTrip.flights.outbound.depAirport" placeholder="HKG" class="w-full text-xs p-1.5 rounded border"><input v-model="activeTrip.flights.outbound.arrAirport" placeholder="NRT" class="w-full text-xs p-1.5 rounded border"></div><input v-model="activeTrip.flights.outbound.flight" placeholder="CX123" class="w-full text-xs p-1.5 rounded border"></div><div class="bg-pink-50 p-3 rounded-xl mb-3"><h4 class="text-xs font-bold text-pink-600 mb-2">å›ç¨‹</h4><input v-model="activeTrip.flights.inbound.date" type="date" class="w-full mb-2 text-xs p-1.5 rounded border"><div class="grid grid-cols-2 gap-2 mb-2"><input v-model="activeTrip.flights.inbound.depTime" type="time" class="w-full text-xs p-1.5 rounded border"><input v-model="activeTrip.flights.inbound.arrTime" type="time" class="w-full text-xs p-1.5 rounded border"></div><div class="grid grid-cols-2 gap-2 mb-2"><input v-model="activeTrip.flights.inbound.depAirport" placeholder="NRT" class="w-full text-xs p-1.5 rounded border"><input v-model="activeTrip.flights.inbound.arrAirport" placeholder="HKG" class="w-full text-xs p-1.5 rounded border"></div><input v-model="activeTrip.flights.inbound.flight" placeholder="CX456" class="w-full text-xs p-1.5 rounded border"></div><button @click="showFlightModal=false;saveAll()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold">å„²å­˜</button></div></div></transition>
        <transition name="fade"><div v-if="showTripSettings" class="absolute inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4"><div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4">è¨­å®š</h3><button @click="exportCurrentTrip" class="w-full mb-3 py-3 bg-gray-100 text-gray-700 text-sm font-bold rounded-lg">ğŸ“¤ åŒ¯å‡ºæ­¤æ—…ç¨‹</button><button @click="deleteCurrentTrip" class="w-full mb-3 py-3 bg-red-50 text-red-500 font-bold rounded-xl text-xs">åˆªé™¤æ—…ç¨‹</button><button @click="showTripSettings=false" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl">é—œé–‰</button></div></div></transition>

    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    // Global
                    allTrips: [], globalPackingList: { carryOn: [], checkIn: [] }, activeTripId: null, viewMode: 'dashboard',
                    // UI
                    currentTab: 'itinerary', // V13: Itinerary is default
                    // V13: Reordered Tabs
                    tabs: [
                        {id:'itinerary',icon:'ğŸ“…',label:'è¡Œç¨‹'},
                        {id:'expenses',icon:'ğŸ’°',label:'å…¬æ•¸'},
                        {id:'shopping',icon:'ğŸ›ï¸',label:'å¿…è²·'},
                        {id:'prep',icon:'ğŸ“',label:'æº–å‚™'}
                    ],
                    selectedDate: '', showFlightDetail: false, showExchangeDetail: false,
                    // Modals
                    showCreateModal: false, showFlightModal: false, showModal: false, showTransModal: false, showTripSettings: false, showStatsModal: false, showShopModal: false, showExchangeModal: false,
                    // Forms
                    createForm: {name:'',start:'',end:'',membersStr:'', currency:'Â¥'},
                    newGlobalItem:'', globalPackingType: 'carryOn', newTodo:'', newPackItem:'', packingType:'carryOn', newShopItem:'',
                    modalMode: 'add', form: {id: null, time:'10:00',location:'',note:'',category:'sight',mapLink:'',img:''},
                    shopMode: 'add', shopIndex: -1, shopForm: {text:'', store:'', img:'', done:false},
                    transMode: 'spend', transForm: {amount:'', who:'', desc:'', category: 'food', date: ''},
                    exchangeForm: {hkd: '', local: ''},
                    expenseCategories: [{id: 'food', label: 'é£Ÿ', icon: 'ğŸœ'},{id: 'drink', label: 'é£²', icon: 'ğŸ¥¤'},{id: 'transport', label: 'è¡Œ', icon: 'ğŸš‡'},{id: 'stay', label: 'ä½', icon: 'ğŸ¨'},{id: 'play', label: 'ç©', icon: 'ğŸ¢'},{id: 'shop', label: 'è²·', icon: 'ğŸ›ï¸'},{id: 'ticket', label: 'é£›', icon: 'ğŸ«'},{id: 'misc', label: 'é›œ', icon: 'ğŸ§©'}]
                }
            },
            computed: {
                activeTrip() { return this.allTrips.find(t => t.id === this.activeTripId) || {}; },
                sortedTrips() { return this.allTrips.slice().sort((a,b) => new Date(b.startDate) - new Date(a.startDate)); },
                generatedDates() {
                    if (!this.activeTripId) return [];
                    let dates = [], curr = new Date(this.activeTrip.startDate), end = new Date(this.activeTrip.endDate);
                    while (curr <= end) { dates.push({ val: curr.toISOString().split('T')[0], display: `${curr.getMonth()+1}/${curr.getDate()}`, weekDay: ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][curr.getDay()] }); curr.setDate(curr.getDate() + 1); }
                    return dates;
                },
                filteredItinerary() { return this.activeTrip.itinerary ? this.activeTrip.itinerary.filter(i => i.date === this.selectedDate).sort((a,b)=>a.time.localeCompare(b.time)) : []; },
                currentPackingList() { return this.packingType === 'carryOn' ? this.activeTrip.packingList.carryOn : this.activeTrip.packingList.checkIn; },
                currentGlobalList() { return this.globalPackingType === 'carryOn' ? this.globalPackingList.carryOn : this.globalPackingList.checkIn; },
                walletCash() { return this.activeTrip.transactions ? this.activeTrip.transactions.reduce((t, x) => (x.type==='deposit'?t+x.amount:(x.type==='spend'||x.type==='borrow'?t-x.amount:t)), 0) : 0; },
                debtSummary() {
                    if(!this.activeTrip.transactions) return {potOwes:{}, owesPot:{}};
                    let potOwes={}, owesPot={}; this.activeTrip.members.forEach(m=>{potOwes[m]=0; owesPot[m]=0;});
                    this.activeTrip.transactions.forEach(t=>{ if(t.type==='advance'&&t.who) potOwes[t.who]+=t.amount; if(t.type==='borrow'&&t.who) owesPot[t.who]+=t.amount; });
                    const cleanPot={}, cleanOwes={}; for(let m in potOwes)if(potOwes[m]>0)cleanPot[m]=potOwes[m]; for(let m in owesPot)if(owesPot[m]>0)cleanOwes[m]=owesPot[m];
                    return {potOwes:cleanPot, owesPot:cleanOwes};
                },
                transTitle() { const map = { spend:'ğŸ’¸ å…¬æ•¸ç¾é‡‘æ”¯å‡º', deposit:'ğŸ’° æ¯äººå…¥é‡‘å……å€¼', advance:'ğŸ™‹â€â™‚ï¸ å¹«å…¬æ•¸å¢Šæ”¯', borrow:'ğŸ¤ å•å…¬æ•¸å€ŸéŒ¢' }; return map[this.transMode]; },
                expenseStats() {
                    if(!this.activeTrip.transactions) return {total:0, byDate:{}, byCat:{}, maxDate:0};
                    let total=0, byDate={}, byCat={};
                    const spends = this.activeTrip.transactions.filter(t => t.type === 'spend');
                    spends.forEach(t => { total += t.amount; byDate[t.date] = (byDate[t.date] || 0) + t.amount; byCat[t.category] = (byCat[t.category] || 0) + t.amount; });
                    const maxDate = Math.max(...Object.values(byDate), 1);
                    const sortedByDate = {}; Object.keys(byDate).sort().forEach(k => sortedByDate[k] = byDate[k]);
                    return { total, byDate: sortedByDate, byCat, maxDate };
                },
                exchangeSummary() {
                    if (!this.activeTrip.exchanges || this.activeTrip.exchanges.length === 0) return { totalHKD: 0, totalLocal: 0, avgRate: 0 };
                    const totalHKD = this.activeTrip.exchanges.reduce((s, i) => s + i.hkd, 0);
                    const totalLocal = this.activeTrip.exchanges.reduce((s, i) => s + i.local, 0);
                    const avgRate = totalLocal > 0 ? (totalHKD / totalLocal) : 0;
                    return { totalHKD, totalLocal, avgRate };
                }
            },
            mounted() { this.loadAllData(); },
            methods: {
                formatNumber(n) { return n ? Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0'; },
                formatRate(r) { return r ? r.toFixed(4) : '0.0000'; },
                saveAll() { localStorage.setItem('travelAppV13_Trips', JSON.stringify(this.allTrips)); localStorage.setItem('travelAppV13_GlobalPacking', JSON.stringify(this.globalPackingList)); },
                loadAllData() { 
                    this.allTrips = JSON.parse(localStorage.getItem('travelAppV13_Trips') || '[]'); 
                    let gp = JSON.parse(localStorage.getItem('travelAppV13_GlobalPacking'));
                    if (!gp || (Array.isArray(gp) && gp.length === 0) || (!Array.isArray(gp) && gp.checkIn.length === 0)) {
                        this.globalPackingList = {
                            checkIn: ["é«®åœˆ","å…§è¡£è¤²","è¡£ç‰©","å¤–å¥—","è¥ªå­","å¸½å­","é…ä»¶","é£¾å“","ç¡è¡£","åŒ–å¦å“","ä¿é¤Šå“","é›»æ£’","æ¢³å­","å¸å¦","æ´—è‡‰","ç‰™åˆ·ã€ç‰™è†","åŒ–å¦æ£‰","éš±çœ¼ç›’ã€éš±çœ¼è—¥æ°´","éš±çœ¼","è—¥å“","ä¿å¥é£Ÿå“","æ‰‹æ©Ÿå……é›»å™¨","è¡Œå‹•é›»æºå……é›»å™¨","Apple Watch Charger","æ‹–é‹","åƒåœ¾è¢‹","æ¯›å·¾","å£ç½©","ç›¥æ´—ç”¨å“","é›¨å‚˜","æ³³è£","é˜²æ›¬ç”¨å“","è¡›ç”Ÿæ£‰","é«®å°¾æ²¹","è¬åœ‹è½‰æ¥é ­","Tim"],
                            carryOn: ["è­·ç…§", "èº«ä»½è­‰", "éŠ€åŒ… (Cash/Cards)", "æ‰‹æ©Ÿ", "å°¿è¢‹ (Power Bank)", "Simå¡/é‡", "çœ¼é¡/å¢¨é¡", "ç­†", "å……é›»ç·š"]
                        };
                        this.saveAll();
                    } else {
                        this.globalPackingList = Array.isArray(gp) ? { carryOn: gp, checkIn: [] } : gp;
                    }
                },
                handleImageUpload(event, target) {
                    const file = event.target.files[0];
                    if (!file) return;
                    if (file.size > 10 * 1024 * 1024) { alert('åœ–ç‰‡å¤ªå¤§ (Max 10MB)'); return; }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                            const MAX_WIDTH = 800; let width = img.width; let height = img.height;
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                            canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height);
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                            if (target === 'itinerary') this.form.img = dataUrl;
                            if (target === 'shop') this.shopForm.img = dataUrl;
                        }; img.src = e.target.result;
                    }; reader.readAsDataURL(file);
                },
                saveExchange() {
                    if(!this.exchangeForm.hkd || !this.exchangeForm.local) return;
                    if(!this.activeTrip.exchanges) this.activeTrip.exchanges = [];
                    this.activeTrip.exchanges.push({ id: Date.now(), hkd: this.exchangeForm.hkd, local: this.exchangeForm.local, rate: this.exchangeForm.hkd / this.exchangeForm.local });
                    this.saveAll(); this.exchangeForm = { hkd: '', local: '' };
                },
                deleteExchange(id) { if(confirm('åˆªé™¤?')) { this.activeTrip.exchanges = this.activeTrip.exchanges.filter(e => e.id !== id); this.saveAll(); } },
                openShopModal(mode, item, index) { this.shopMode = mode; this.shopIndex = index; if(mode === 'edit') this.shopForm = { ...item }; else this.shopForm = { text:'', store:'', img:'', done:false }; this.showShopModal = true; },
                saveShopItem() { if (!this.shopForm.text) return; if(this.shopMode==='add') this.activeTrip.shoppingList.push({...this.shopForm}); else this.activeTrip.shoppingList[this.shopIndex]={...this.shopForm}; this.saveAll(); this.showShopModal=false; },
                toggleShopItem(i) { this.activeTrip.shoppingList[i].done=!this.activeTrip.shoppingList[i].done;this.saveAll(); },
                deleteShopItem(i) { this.activeTrip.shoppingList.splice(i,1);this.saveAll(); },
                openModal(mode, item = null) { this.modalMode = mode; if (mode === 'edit' && item) this.form = { ...item }; else this.form = { id: null, time:'10:00',location:'',note:'',category:'sight',mapLink:'',img:'' }; this.showModal = true; },
                saveItem() { if (!this.form.location) return; if (this.modalMode === 'add') this.activeTrip.itinerary.push({id:Date.now(),date:this.selectedDate,...this.form}); else { const idx = this.activeTrip.itinerary.findIndex(i => i.id === this.form.id); if (idx !== -1) this.activeTrip.itinerary[idx] = { ...this.form, date: this.selectedDate }; } this.saveAll(); this.showModal=false; },
                deleteItem(id) { if(confirm('åˆªé™¤?')){this.activeTrip.itinerary=this.activeTrip.itinerary.filter(i=>i.id!==id);this.saveAll();} },
                openGlobalPacking() { this.viewMode = 'globalPacking'; },
                openTrip(id) { this.activeTripId = id; this.viewMode = 'trip'; this.selectedDate = this.activeTrip.startDate; this.showFlightDetail = false; this.showExchangeDetail = false; },
                exitTrip() { this.activeTripId = null; this.viewMode = 'dashboard'; },
                createTrip() { 
                    if(!this.createForm.name || !this.createForm.start) return alert('è«‹å¡«å¯«è³‡æ–™'); 
                    const newTrip = { id: Date.now(), name: this.createForm.name, startDate: this.createForm.start, endDate: this.createForm.end || this.createForm.start, members: this.createForm.membersStr.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(s=>s).length ? this.createForm.membersStr.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(s=>s) : ['æˆ‘'], currency: this.createForm.currency, itinerary: [], shoppingList: [], transactions: [], todos: [], packingList: { carryOn:[], checkIn:[] }, exchanges: [], flights: { outbound: {date:this.createForm.start,flight:'',depTime:'',arrTime:'',depAirport:'',arrAirport:''}, inbound: {date:this.createForm.end,flight:'',depTime:'',arrTime:'',depAirport:'',arrAirport:''} } }; 
                    this.allTrips.push(newTrip); this.saveAll(); this.showCreateModal=false; this.createForm={name:'',start:'',end:'',membersStr:'', currency:'Â¥'}; 
                },
                importTrip() { const str=prompt('å‚™ä»½ç¢¼:'); if(str) try{const t=JSON.parse(str);t.id=Date.now();this.allTrips.push(t);this.saveAll();alert('âœ…');}catch(e){alert('âŒ');} },
                exportCurrentTrip() { navigator.clipboard.writeText(JSON.stringify(this.activeTrip)).then(()=>alert('âœ…')); },
                deleteCurrentTrip() { if(confirm('åˆªé™¤?')){this.allTrips=this.allTrips.filter(t=>t.id!==this.activeTripId);this.saveAll();this.exitTrip();} },
                addGlobalItem() { const l = this.globalPackingType === 'carryOn' ? this.globalPackingList.carryOn : this.globalPackingList.checkIn; if(this.newGlobalItem){ l.push(this.newGlobalItem); this.newGlobalItem=''; this.saveAll(); } },
                removeGlobalItem(i) { const l = this.globalPackingType === 'carryOn' ? this.globalPackingList.carryOn : this.globalPackingList.checkIn; l.splice(i,1); this.saveAll(); },
                importFromMaster() { if(confirm('åŒ¯å…¥é€šç”¨æ¸…å–®?')){ this.globalPackingList.carryOn.forEach(item => { if(!this.activeTrip.packingList.carryOn.find(x=>x.text===item)) this.activeTrip.packingList.carryOn.push({text:item,done:false}); }); this.globalPackingList.checkIn.forEach(item => { if(!this.activeTrip.packingList.checkIn.find(x=>x.text===item)) this.activeTrip.packingList.checkIn.push({text:item,done:false}); }); this.saveAll(); } },
                openLink(url) { window.open(url, '_blank'); },
                addTodo() { if(this.newTodo){this.activeTrip.todos.push({text:this.newTodo,done:false});this.newTodo='';this.saveAll();} },
                toggleTodo(i) { this.activeTrip.todos[i].done=!this.activeTrip.todos[i].done;this.saveAll(); },
                deleteTodo(i) { this.activeTrip.todos.splice(i,1);this.saveAll(); },
                addPackItem() { const l=this.packingType==='carryOn'?this.activeTrip.packingList.carryOn:this.activeTrip.packingList.checkIn; if(this.newPackItem){l.push({text:this.newPackItem,done:false});this.newPackItem='';this.saveAll();} },
                togglePackItem(i) { const l=this.packingType==='carryOn'?this.activeTrip.packingList.carryOn:this.activeTrip.packingList.checkIn; l[i].done=!l[i].done;this.saveAll(); },
                deletePackItem(i) { const l=this.packingType==='carryOn'?this.activeTrip.packingList.carryOn:this.activeTrip.packingList.checkIn; l.splice(i,1);this.saveAll(); },
                openTransModal(m) { this.transMode=m; const today = new Date().toISOString().split('T')[0]; this.transForm={amount:'', who:this.activeTrip.members[0], desc:'', category:'food', date: today}; this.showTransModal=true; },
                saveTransaction() { if(!this.transForm.amount) return; const dStr = this.transForm.date || new Date().toISOString().split('T')[0]; let t = {id:Date.now(), date: dStr, type:this.transMode, ...this.transForm}; if(this.transMode==='deposit') { t.amount*=this.activeTrip.members.length; t.who='All'; t.desc=`æ¯äºº ${this.activeTrip.currency || 'Â¥'}${this.transForm.amount}`; } this.activeTrip.transactions.push(t); this.saveAll(); this.showTransModal=false; },
                openStats() { this.showStatsModal = true; },
                getTypeText(t) { return {deposit:'å…¥é‡‘',spend:'æ”¯å‡º',advance:'å¢Šæ”¯',borrow:'å€Ÿæ¬¾'}[t]||t; },
                getAmountColor(t) { return t==='deposit'?'text-green-600':(t==='spend'?'text-red-500':(t==='advance'?'text-orange-500':'text-blue-500')); },
                getCategoryColor(c) { const map={sight:'border-purple-500',food:'border-orange-500',play:'border-pink-500',stay:'border-blue-500',other:'border-gray-400'}; return map[c]; },
                getCategoryBadge(c) { const map={sight:'text-purple-600 bg-purple-50',food:'text-orange-600 bg-orange-50',play:'text-pink-600 bg-pink-50',stay:'text-blue-600 bg-blue-50',other:'text-gray-600 bg-gray-50'}; return map[c]; },
                getCategoryLabel(c) { const map={sight:'æ™¯é»',food:'åƒå–',play:'ç©æ¨‚',stay:'ä½å®¿',other:'å…¶ä»–'}; return map[c]; },
                getExpCatIcon(c) { return this.expenseCategories.find(x=>x.id===c)?.icon || 'ğŸ’¸'; },
                getExpCatLabel(c) { return this.expenseCategories.find(x=>x.id===c)?.label || 'æ”¯å‡º'; }
            }
        }).mount('#app');
    </script>
</body>
</html>